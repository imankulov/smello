{% extends "base.html" %}

{% block title %}Smello - Requests{% endblock %}

{% block content %}
<h2>Captured Requests</h2>

<form method="get" action="/" class="filters" role="group">
    <input type="search" name="search" placeholder="Search URL..." value="{{ filter_search }}">
    <select name="host">
        <option value="">All hosts</option>
        {% for h in hosts %}
        <option value="{{ h }}" {% if h == filter_host %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
    </select>
    <select name="method">
        <option value="">All methods</option>
        {% for m in methods %}
        <option value="{{ m }}" {% if m == filter_method %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
    </select>
    <button type="submit">Filter</button>
</form>

{% if requests %}
<figure>
<table class="striped">
    <thead>
        <tr>
            <th>Time</th>
            <th>Method</th>
            <th>URL</th>
            <th>Status</th>
            <th>Duration</th>
        </tr>
    </thead>
    <tbody hx-get="/api/requests" hx-trigger="every 3s" hx-swap="none">
        {% for req in requests %}
        <tr class="clickable-row" onclick="window.location='/requests/{{ req.id }}'">
            <td><small>{{ req.timestamp.strftime('%H:%M:%S') }}</small></td>
            <td><strong>{{ req.method }}</strong></td>
            <td class="url-cell" title="{{ req.url }}">{{ req.host }}{{ req.url | replace('https://' ~ req.host, '') | replace('http://' ~ req.host, '') | truncate(60) }}</td>
            <td>
                <span class="status-badge
                    {% if req.status_code >= 500 %}status-5xx
                    {% elif req.status_code >= 400 %}status-4xx
                    {% elif req.status_code >= 300 %}status-3xx
                    {% else %}status-2xx{% endif %}">
                    {{ req.status_code }}
                </span>
            </td>
            <td><small>{{ req.duration_ms }}ms</small></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</figure>
<div class="clear-all-row">
    <button class="outline secondary clear-all-btn" hx-delete="/api/requests" hx-swap="none"
            hx-on::after-request="window.location.reload()">Clear All</button>
</div>
{% else %}
<article>
    <p>No captured requests yet. Add <code>import smello; smello.init()</code> to your Python code and make some HTTP requests.</p>
</article>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Auto-reload the page every 3 seconds to show new requests
let lastCount = {{ requests | length }};
setInterval(async () => {
    try {
        const resp = await fetch('/api/requests');
        const data = await resp.json();
        if (data.length !== lastCount) {
            window.location.reload();
        }
    } catch(e) {}
}, 3000);
</script>
{% endblock %}
